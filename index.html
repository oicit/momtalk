<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤å¨å¤·å¤§å²›å¤§å†’é™© - å®Œæ•´å†…å®¹è›‡å½¢å¯¹é½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --duo-green: #58cc02;
            --duo-blue: #1cb0f6;
            --duo-orange: #ff9600;
            --duo-purple: #ce82ff;
            --duo-red: #ff4b4b;
            --duo-yellow: #ffc800;
        }
        body {
            font-family: 'Nunito', 'Noto Sans SC', sans-serif;
            background-color: #f7f7f7;
            color: #4b4b4b;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
        }
        .duo-card {
            border: 2px solid #e5e5e5;
            border-bottom: 6px solid #e5e5e5;
        }
        
        /* æ—¶é—´è½´èŠ‚ç‚¹æ ·å¼ */
        .step-circle {
            width: 70px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-bottom: 6px solid rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            background-color: white;
        }
        .step-circle.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 8px rgba(28, 176, 246, 0.2);
            border-bottom-width: 2px;
        }
        #map { height: 100%; width: 100%; z-index: 1; border-radius: 0; }
        
        /* åœ°å›¾æ ‡æ³¨æ ·å¼ */
        .day-label {
            background: transparent;
            font-weight: 950;
            font-size: 20px; 
            text-align: center;
            white-space: nowrap;
            color: #fff;
            text-shadow: 
                -1.2px -1.2px 0 #000, 1.2px -1.2px 0 #000, 
                -1.2px 1.2px 0 #000, 1.2px 1.2px 0 #000;
            pointer-events: none;
        }

        .plane-marker {
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* POI å…´è¶£ç‚¹å›¾æ ‡ */
        .poi-marker {
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            width: 32px;
            height: 32px;
        }

        /* è›‡å½¢è¿›åº¦ç½‘æ ¼ */
        .path-grid {
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: 150px;
            gap: 0 20px;
            padding: 40px 20px;
        }
        
        /* è›‡å½¢è¿æ¥çº¿ */
        .snake-line {
            position: absolute;
            background: #e5e5e5;
            z-index: 1;
            border-radius: 4px;
        }
        .line-h { height: 8px; }
        .line-v { width: 8px; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        
        .toggle-btn {
            background-color: #fff; border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5;
            padding: 4px 12px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: all 0.1s;
        }
        .toggle-btn.active { background-color: #58cc02; color: white; border-color: #46a302; }
        
        /* Map Control Buttons */
        .map-btn {
            background-color: #fff;
            border: 2px solid #e5e5e5;
            border-bottom: 4px solid #e5e5e5;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            font-size: 14px;
            white-space: nowrap;
        }
        .map-btn:active {
            border-bottom-width: 2px;
            transform: translateY(2px);
        }

        .timeline-day-text {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 2px;
        }
        .timeline-title-text {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 4px;
        }

        .section-title { font-weight: 900; font-size: 14px; text-transform: uppercase; color: #afafaf; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }
        .editable-field:focus { outline: 2px solid var(--duo-blue); background: #fff; border-radius: 4px; padding: 2px; }
        .comment-box { border: 2px dashed #e5e5e5; padding: 15px; border-radius: 20px; margin-top: 25px; background: #fff; }
        .drag-handle { cursor: grab; color: #ccc; display: none; margin-right: 10px; }
        .edit-mode .drag-handle { display: flex; }

        /* èˆªçº¿æµåŠ¨åŠ¨ç”» */
        @keyframes dash-flow {
            from { stroke-dashoffset: 40; }
            to { stroke-dashoffset: 0; }
        }
        .route-path-flow {
            stroke-dasharray: 15, 25;
            animation: dash-flow 2s linear infinite;
        }
        /* ç®­å¤´å›¾æ ‡æ ·å¼ */
        .arrow-icon {
            font-size: 18px;
            color: #1cb0f6;
            text-shadow: 0 0 4px white;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0.9;
        }
    </style>
</head>
<body class="edit-mode-disabled">

    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼šåŒ…å«æ ‡é¢˜å’Œæè¿° -->
    <nav class="bg-white border-b-2 border-gray-200 px-6 py-2 flex justify-between items-center shrink-0 z-50 shadow-sm">
        <div class="flex items-center gap-4">
            <span class="text-4xl">ğŸŒ´</span>
            <div class="flex flex-col">
                <h1 class="font-black text-xl md:text-2xl tracking-tight text-[#58cc02] leading-none" id="nav-title">å¤å¨å¤·å¤§å²›å¤§å†’é™©</h1>
                <p class="text-[10px] md:text-xs font-bold text-gray-400 mt-1" id="nav-desc">ä»çœ‹ç«å±±å£å²©æµ†åˆ°ç»ç¾æ²™æ»©å’Œæ·±é‚ƒæµ·åº•ï¼</p>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <button onclick="toggleEditMode()" class="toggle-btn" id="edit-toggle">ğŸ“ <span class="lang-target" data-zh="ç¼–è¾‘" data-en="EDIT">ç¼–è¾‘</span></button>
            <button onclick="toggleLanguage()" class="toggle-btn" id="lang-toggle">ä¸­ / EN</button>
            <div class="w-10 h-10 rounded-full bg-blue-400 border-2 border-blue-500 overflow-hidden shadow-sm">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="avatar">
            </div>
        </div>
    </nav>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- åœ°å›¾åŒºåŸŸ -->
        <div class="w-full md:w-[65%] h-[40vh] md:h-full border-r-2 border-gray-200 relative">
            <div id="map"></div>
            <!-- åœ°å›¾æ§åˆ¶æŒ‰é’®ç»„ -->
            <div class="absolute top-4 right-4 z-[1000] flex flex-col gap-2 items-end">
                <button onclick="resetMapView()" class="map-btn shadow-md hover:bg-gray-50">
                    ğŸ  <span id="reset-view-text">é‡ç½®è§†å›¾</span>
                </button>
                <button onclick="togglePoiVisibility()" class="map-btn shadow-md hover:bg-gray-50">
                    ğŸ“ <span id="poi-toggle-text">éšè—æ™¯ç‚¹</span>
                </button>
            </div>
        </div>

        <!-- æ—¶é—´è½´è¿›åº¦åŒºåŸŸ -->
        <div id="timelineContainer" class="w-full md:w-[35%] h-full overflow-y-auto custom-scroll bg-white p-4 md:p-6 text-center">
            <div class="max-w-[320px] mx-auto">
                <h2 class="font-black text-xl mb-1" id="timeline-title">å†’é™©è·¯å¾„</h2>
                <p class="text-gray-400 font-extrabold uppercase tracking-widest text-[9px]">SNAKE PROGRESSION</p>
                <div class="path-grid mt-4" id="path-grid"></div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="dayModal" class="modal" onclick="closeModal(event)">
        <div class="bg-white rounded-3xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh] shadow-2xl" onclick="event.stopPropagation()">
            <div id="modalHeader" class="p-4 md:p-5 text-white shrink-0 relative">
                <button class="absolute top-4 right-6 text-3xl font-bold opacity-70 hover:opacity-100" onclick="closeModal()">Ã—</button>
                <div class="inline-block bg-white/20 px-3 py-1 rounded-full text-[10px] font-black mb-1 uppercase tracking-widest lang-target" data-zh="æ¢é™©ä»»åŠ¡" data-en="MISSION">æ¢é™©ä»»åŠ¡</div>
                <h2 id="modalTitle" class="text-2xl md:text-3xl font-black leading-tight"></h2>
                <p id="modalDate" class="text-sm font-bold opacity-90"></p>
            </div>
            <div class="p-6 md:p-8 overflow-y-auto custom-scroll bg-[#fcfcfc] flex-1 text-left" id="modalContent"></div>
            <div id="save-indicator" class="hidden p-2 bg-green-100 text-green-700 text-center text-xs font-bold">âœ“ å·²ä¿å­˜ / Saved</div>
        </div>
    </div>

    <script>
        let currentLang = 'zh';
        let editMode = false;
        let poisVisible = true;
        let leafletMap = null;
        let activeMarkers = [];
        let activeLabels = [];
        let activePois = [];
        
        // æœ¬åœ°å­˜å‚¨
        let userEdits = JSON.parse(localStorage.getItem('hawaii_adventure_v1')) || {};

        const CRATER_COORD = [19.412, -155.285];
        const INITIAL_MAP_CENTER = [19.7, -155.5];
        const INITIAL_MAP_ZOOM = 9;

        const itinerary = {
            1: { zh: { title: "æŠµè¾¾ä¸çº¢å…‰å¤œå½± ğŸŒ‹", date: "Day 1", timeline: "æŠµè¾¾ä¸çº¢å…‰", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼šå¤œæ™šé«˜æµ·æ‹”å¯’å†·ï¼Œè¯·ä¸ºå¥¶å¥¶å’Œå­©å­å¤‡å¥½è½»ä¾¿å¤–å¥—ã€‚æœ›è¿œé•œæ˜¯çœ‹ç«å±±å£ç»†èŠ‚çš„ç¥å™¨ã€‚æ£€æŸ¥â€œAfter Dark in the Parkâ€è®²åº§è®¡åˆ’ã€‚" }, en: { title: "Arrival & Glow ğŸŒ‹", date: "Day 1", timeline: "Arrival", expert: "ğŸ’¡ EXPERT: Evenings are chillyâ€”pack layers! Use binoculars for crater viewing. Check the 'After Dark in the Park' lecture series." }, color: "#ff4b4b", coords: CRATER_COORD, labelOffset: [40, 40], pois: [
                { icon: "ğŸ¢", zh: "PunaluÊ»u é»‘æ²™æ»©", en: "PunaluÊ»u Black Sand", coords: [19.135, -155.503] },
                { icon: "ğŸŒ«ï¸", zh: "Steaming Bluff è’¸æ±½å­”", en: "Steaming Bluff", coords: [19.422, -155.263] },
                { icon: "ğŸ›–", zh: "Volcano Village ç«å±±æ‘", en: "Volcano Village", coords: [19.428, -155.234] }
            ], events: [
                { id: 0, icon: "ğŸ›«", zh: { name: "è½åœ°ç§‘çº³ä¸é©¾é©¶", time: "1:13 PM é™è½", desc: "å–è½¦åæ²¿ Saddle Road é©¾é©¶æ™¯è§‚æä½³ã€‚ä¸­é€”åœ¨ PunaluÊ»u é»‘æ²™æ»©åœç•™å¯»æ‰¾æµ·é¾Ÿã€‚ä¿æŒ 10 è‹±å°ºè·ç¦»è§„åˆ™ã€‚" }, en: { name: "Arrival & Drive", time: "1:13 PM", desc: "Pick up car and drive via Saddle Road. Stop at PunaluÊ»u Black Sand Beach to see turtles. Keep 10ft distance." } },
                { id: 1, icon: "ğŸ›–", zh: { name: "å…¥ä½ Volcano Village", time: "ä¸‹åˆ", desc: "å…¥ä½é›¨æ—åŒº Volcano Villageã€‚æ­¤å¤„æ¯”ç§‘çº³å¯’å†·ï¼Œè¯·å‡†å¤‡å¥½å¤–å¥—ã€‚åœ¨æ‘åº„å¸‚åœºè¡¥å……ç‰©èµ„ã€‚" }, en: { name: "Check-in Volcano", time: "Afternoon", desc: "Check in at Volcano Village. It's much cooler than Konaâ€”pack layers! Stock up at market." } },
                { id: 2, icon: "ğŸ”¥", zh: { name: "ç«å±±å£çº¢å…‰è§‚èµ", time: "å…¥å¤œ", desc: "å‰å¾€ KÄ«lauea Overlook æˆ– Steaming Bluff è§‚å¯Ÿ HalemaÊ»umaÊ»u çº¢å…‰ã€‚è¿™æ˜¯è§‚çœ‹ç†”å²©æ¹–çš„æœ€ä½³æ—¶æœºã€‚" }, en: { name: "Evening Glow", time: "Night", desc: "View the glow at HalemaÊ»umaÊ»u from KÄ«lauea Overlook or Steaming Bluff overlooks." } }
            ]},
            2: { zh: { title: "ç«å±±æ·±åº¦æ¢ç´¢ ğŸŒ‹", date: "Day 2", timeline: "æ·±åº¦æ¢ç´¢", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼šç‘Ÿæ–¯é¡¿ç†”å²©ç®¡å»ºè®® 9AM å‰è®¿é—®ã€‚Haâ€˜akulamanu (Sulphur Banks) æ­¥é“å¹³å¦ï¼Œé€‚åˆå¥¶å¥¶ã€‚" }, en: { title: "Explorer Day ğŸŒ‹", date: "Day 2", timeline: "Explorer", expert: "ğŸ’¡ EXPERT: Visit Thurston Lava Tube before 9AM. Haâ€˜akulamanu is flat and accessible for elders." }, color: "#ff9600", coords: [19.412, -155.245], labelOffset: [-10, 0], pois: [
                { icon: "ğŸ•³ï¸", zh: "Thurston ç†”å²©éš§é“", en: "Thurston Lava Tube", coords: [19.414, -155.239] },
                { icon: "ğŸ—¿", zh: "Puâ€˜uloa å¤çŸ³åˆ»", en: "Puâ€˜uloa Petroglyphs", coords: [19.286, -155.127] },
                { icon: "ğŸ’¨", zh: "Sulphur Banks", en: "Sulphur Banks", coords: [19.431, -155.258] }
            ], events: [
                { id: 0, icon: "ğŸŒ‹", zh: { name: "Kilauea Iki ç¯çº¿", time: "æ—©æ™¨", desc: "å¾’æ­¥ 4 è‹±é‡Œç¯çº¿ã€‚ç©¿è¶Šå‡å›ºçš„ç†”å²©æ¹–ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„åŠ›é‡ã€‚éšåè®¿é—®æ‹¥æœ‰ 500 å¹´å†å²çš„ Thurston ç†”å²©éš§é“ã€‚" }, en: { name: "Kilauea Iki Loop", time: "Morning", desc: "Hike the 4-mile loop crossing a former lava lake. Visit the 500-year-old Thurston Lava Tube cave." } },
                { id: 1, icon: "ğŸ’¨", zh: { name: "ç‰ç£ºå ¤ä¸è’¸æ±½å­”", time: "ä¸Šåˆ", desc: "è¡Œèµ° Haâ€˜akulamanu æ­¥é“çœ‹ç«å±±æ°”ä½“å–·å‘ã€‚ä¸­åˆåœ¨ Volcano House äº«ç”¨åˆé¤ä¿¯ç°ç«å±±å£ã€‚" }, en: { name: "Sulphur Banks", time: "AM", desc: "Walk the easy 1.2-mile Haâ€˜akulamanu Trail. Lunch at Volcano House overlooking the crater." } },
                { id: 2, icon: "ğŸ—¿", zh: { name: "é“¾è·¯è·¯ä¸å¤çŸ³åˆ»", time: "ä¸‹åˆ", desc: "é©¾é©¶ Chain of Craters Road 23 è‹±é‡Œã€‚åœ¨ Puâ€˜uloa è§‚å¯Ÿ 2.3 ä¸‡ä¸ªå¤çŸ³åˆ»ã€‚å®Œæˆ Junior Ranger æ‰‹å†Œé¢†å‹‹ç« ã€‚" }, en: { name: "Petroglyphs Drive", time: "PM", desc: "Drive the 23-mile Chain of Craters Road. See 23,000 carvings at Puâ€˜uloa. Complete Junior Ranger booklet." } }
            ]},
            3: { zh: { title: "å¸Œæ´›ç§‘å­¦ä¸ç€‘å¸ƒä¹‹æ—…", date: "Day 3", timeline: "é›¨æ—ç§‘å­¦", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼šå¸Œæ´›æ—©æ™¨æ˜“è§å½©è™¹ã€‚â€˜Akaka ç€‘å¸ƒè½å·® 442 è‹±å°ºï¼Œä½†æ­¥é“æœ‰æ¥¼æ¢¯ï¼Œè¯·æ³¨æ„ä½“åŠ›ã€‚" }, en: { title: "Hilo Science", date: "Day 3", timeline: "Science", expert: "ğŸ’¡ EXPERT: Rainbows are common in Hilo. Akaka Falls is a 442ft drop, but note stairs on the trail." }, color: "#58cc02", coords: [19.724, -155.087], pois: [
                { icon: "ğŸ’", zh: "PanaÊ»ewa é›¨æ—åŠ¨ç‰©å›­", en: "PanaÊ»ewa Zoo", coords: [19.664, -155.074] },
                { icon: "ğŸŒˆ", zh: "å½©è™¹ç€‘å¸ƒ", en: "Rainbow Falls", coords: [19.719, -155.110] },
                { icon: "ğŸŒŠ", zh: "é˜¿å¡å¡ç€‘å¸ƒ", en: "Akaka Falls", coords: [19.854, -155.153] },
                { icon: "ğŸ”­", zh: "Ê»Imiloa å¤©æ–‡ä¸­å¿ƒ", en: "Ê»Imiloa Astronomy", coords: [19.702, -155.081] },
                { icon: "ğŸ“", zh: "Lyman åšç‰©é¦†", en: "Lyman Museum", coords: [19.722, -155.088] }
            ], events: [
                { id: 0, icon: "ğŸµ", zh: { name: "é›¨æ—åŠ¨ç‰©å›­", time: "æ—©æ™¨", desc: "è®¿é—® PanaÊ»ewa åŠ¨ç‰©å›­ã€‚çœ‹èœ˜è››çŒ´ã€å°¼å°¼é¹…å’Œå…°èŠ±èŠ±å›­ã€‚è¿™æ˜¯å…¨ç¾å”¯ä¸€çš„é›¨æ—åŠ¨ç‰©å›­ã€‚" }, en: { name: "Rainforest Zoo", time: "AM", desc: "Visit PanaÊ»ewa Zoo. See monkeys, lemurs, and nÄ“nÄ“. It's also a botanical garden." } },
                { id: 1, icon: "ğŸŒˆ", zh: { name: "å¸Œæ´›ç§‘å­¦ä¸ç€‘å¸ƒ", time: "ä¸Šåˆ", desc: "çœ‹å½©è™¹ç€‘å¸ƒã€‚å‚è§‚ Lyman åšç‰©é¦†äº†è§£è‡ªç„¶å†å²ã€‚æˆ–å» â€˜Imiloa å¤©æ–‡ä¸­å¿ƒçœ‹çƒå¹•ç”µå½±ã€‚" }, en: { name: "Hilo Science", time: "AM", desc: "Visit Rainbow Falls. Explore Lyman Museum or Ê»Imiloa Astronomy Center's planetarium." } },
                { id: 2, icon: "ğŸŒŠ", zh: { name: "é˜¿å¡å¡ç€‘å¸ƒ", time: "ä¸‹åˆ", desc: "æ²¿å“ˆé©¬åº“äºšæµ·å²¸é©¾é©¶ã€‚å¾’æ­¥ 0.4 è‹±é‡Œè·¯å¾„çœ‹ 442 è‹±å°ºé«˜çš„é˜¿å¡å¡ç€‘å¸ƒã€‚éšåå‰å¾€ Waikoloa å…¥ä½ã€‚" }, en: { name: "Akaka Falls", time: "PM", desc: "Drive Hamakua Coast. Hike to Akaka Falls (442ft). Continue to Paniolo Greens." } }
            ]},
            4: { zh: { title: "åŒ—ç§‘å“ˆæ‹‰ï¼šç‰›ä»”æ–‡åŒ– ğŸ", date: "Day 4", timeline: "ç‰›ä»”æ–‡åŒ–", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼šå‘¨å››æ™š Kings' Shops å¸¸æœ‰è‰è£™èˆã€‚Keiki åšç‰©é¦†ï¼ˆé—¨ç¥¨$10-15ï¼‰é€‚åˆå­©å­æ¶ˆè€—ä½“åŠ›ã€‚" }, en: { title: "Cowboy Culture ğŸ", date: "Day 4", timeline: "Paniolo", expert: "ğŸ’¡ EXPERT: Thursday hula at Kings' Shops. Keiki Museum ($10-15) is great for kids' energy." }, color: "#ce82ff", coords: [20.02, -155.66], pois: [
                { icon: "ğŸ", zh: "Parker Ranch ç‰§åœº", en: "Parker Ranch", coords: [20.021, -155.666] },
                { icon: "â›±ï¸", zh: "Hapuna ç™½æ²™æ»©", en: "Hapuna Beach", coords: [19.992, -155.825] },
                { icon: "ğŸ", zh: "Big Island Bees", en: "Big Island Bees", coords: [19.475, -155.898] },
                { icon: "ğŸ—¿", zh: "Puako çŸ³åˆ»", en: "Puako Petroglyphs", coords: [19.923, -155.856] }
            ], events: [
                { id: 0, icon: "â›±ï¸", zh: { name: "æ²™æ»©ä¸Šåˆ", time: "ä¸Šåˆ", desc: "åœ¨ Hapuna æˆ– Waialea Bay äº«å—ç™½æ²™æ»©ä¸æ¸©å’Œæµ·æµªã€‚éšåè®¿é—® Kings' Shops çš„ Keiki ç§‘å­¦åšç‰©é¦†ã€‚" }, en: { name: "Beach Morning", time: "AM", desc: "Enjoy Hapuna or Waialea Beach. Visit Hawaii Keiki Museum in Waikoloa." } },
                { id: 1, icon: "ğŸ¤ ", zh: { name: "ç‰›ä»”æ–‡åŒ–ä¸å¨ç¾äºš", time: "ä¸‹åˆ", desc: "å‚è§‚ Parker Ranch äº†è§£ç‰›ä»”å†å²ã€‚æˆ–å» Big Island Bees ä½“éªŒèœ‚èœœå“é‰´ã€‚åŒ—è¡Œå¯çœ‹ PololÅ« è°·ç¾æ™¯ã€‚" }, en: { name: "Paniolo Culture", time: "PM", desc: "Parker Ranch history. Honey tasting at Big Island Bees. Drive to PololÅ« Valley viewpoint." } },
                { id: 2, icon: "ğŸ’ƒ", zh: { name: "å¢å¥¥æ™šå®´", time: "æ™šä¸Š", desc: "åœ¨åº¦å‡æ‘é¢„è®¢ Legends of Hawaiâ€˜i å¢å¥¥å¤§é¤ã€‚æ¬£èµç«åˆ€èˆã€è‰è£™èˆå¹¶è†å¬æµ·å²›æ•…äº‹ã€‚" }, en: { name: "Luau Night", time: "Night", desc: "Legends of Hawaiâ€˜i Luau. Fire-knife dancing, hula, and island stories." } }
            ]},
            5: { zh: { title: "å¤§æµ·é‚€çº¦ï¼šæ·±è“æŒ‘æˆ˜ ğŸ‹", date: "Day 5", timeline: "æ·±è“æŒ‘æˆ˜", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼š2æœˆæ˜¯è§‚é²¸å·…å³°æœŸã€‚äºšç‰¹å…°è’‚æ–¯æ½œæ°´è‰‡è¦æ±‚èº«é«˜ 36 è‹±å¯¸ä»¥ä¸Šã€‚é­”é¬¼é±¼å¤œæ½œå»ºè®®é•¿è¾ˆåœ¨èˆ¹ä¸Šè§‚å¯Ÿã€‚" }, en: { title: "Deep Sea ğŸ‹", date: "Day 5", timeline: "Ocean", expert: "ğŸ’¡ EXPERT: February is peak whale season. Atlantis Submarine min height 36\". Watch mantas from boat!" }, color: "#1cb0f6", coords: [19.64, -156.02], pois: [
                { icon: "ğŸ‹", zh: "è§‚é²¸ç å¤´", en: "Whale Watching", coords: [19.638, -155.996] },
                { icon: "ğŸ ", zh: "Captain Cook æµ®æ½œ", en: "Captain Cook Snorkel", coords: [19.481, -155.933] },
                { icon: "âœ¨", zh: "é­”é¬¼é±¼æ½œç‚¹", en: "Manta Ray Site", coords: [19.605, -155.996] },
                { icon: "ğŸ”­", zh: "Mauna Kea ä¸­å¿ƒ", en: "Mauna Kea VC", coords: [19.759, -155.456] }
            ], events: [
                { id: 0, icon: "ğŸ‹", zh: { name: "è§‚é²¸ä¸æ½œæ°´è‰‡", time: "ä¸Šåˆ", desc: "ä¹˜åè§‚é²¸èˆ¹ï¼ˆ2æœˆå·…å³°ï¼‰ã€‚æˆ–ä¹˜åäºšç‰¹å…°è’‚æ–¯æ½œæ°´è‰‡ä¸‹æ½œ 100 è‹±å°ºçœ‹çŠç‘šç¤ä¸æ²‰èˆ¹ã€‚" }, en: { name: "Whales & Sub", time: "AM", desc: "Peak whale season cruise. Or Atlantis Submarine dive 100ft below." } },
                { id: 1, icon: "ğŸ ", zh: { name: "åº“å…‹èˆ¹é•¿æµ®æ½œ", time: "ä¸‹åˆ", desc: "å‰å¾€ Kealakekua Bayã€‚åœ¨çºªå¿µç¢‘é™„è¿‘æµ®æ½œï¼Œçœ‹äº”å½©æ–‘æ–“çš„çŠç‘šé±¼ç±»ã€‚æˆ–è®¿é—®çƒ­å¸¦æ¤ç‰©å›­ã€‚" }, en: { name: "Captain Cook", time: "PM", desc: "Snorkel Kealakekua Bay. Or explore Hawaii Tropical Bioreserve & Garden." } },
                { id: 2, icon: "âœ¨", zh: { name: "é­”é¬¼é±¼å¤œæ½œ/è§‚æ˜Ÿ", time: "æ™šä¸Š", desc: "ç§‘çº³æ‹›ç‰Œé­”é¬¼é±¼å¤œæ½œã€‚æˆ–è€…å‰å¾€ Mauna Kea è®¿é—®ä¸­å¿ƒï¼Œåœ¨ 9,200 è‹±å°ºé«˜åº¦ä½“éªŒä¸“ä¸šè§‚æ˜Ÿã€‚" }, en: { name: "Manta/Stargazing", time: "Night", desc: "Iconic Manta Ray night snorkel. Or Mauna Kea Visitor Center stargazing." } }
            ]},
            6: { zh: { title: "æ”¶è·ä¸é“åˆ« âœˆï¸", date: "Day 6", timeline: "æ”¶è·å‘Šåˆ«", expert: "ğŸ’¡ ä¸“å®¶å»ºè®®ï¼šè¿˜è½¦å‰å»ä¹°ç§‘çº³å’–å•¡å’Œç™½è‰²èœ‚èœœã€‚æœºåœºå»ºè®®æå‰ 2.5 å°æ—¶æŠµè¾¾ã€‚" }, en: { title: "Farewell âœˆï¸", date: "Day 6", timeline: "Departure", expert: "ğŸ’¡ EXPERT: Last-minute Kona coffee/honey shopping. Arrive at KOA 2.5h early." }, color: "#afafaf", coords: [19.74, -156.04], pois: [
                { icon: "â˜•", zh: "ç§‘çº³å’–å•¡äº§åŒº", en: "Kona Coffee District", coords: [19.55, -155.92] },
                { icon: "ğŸŸï¸", zh: "è€æœºåœºå…¬å›­", en: "Old Airport Park", coords: [19.645, -156.01] }
            ], events: [
                { id: 0, icon: "ğŸŒŠ", zh: { name: "æœ€åçš„æ¼«æ­¥", time: "ä¸Šåˆ", desc: "åœ¨ AnaehoÊ»omalu Bay è¿›è¡Œæœ€åä¸€æ¬¡æ¸¸æ³³ã€‚é€›é€›å†œè´¸å¸‚åœºé‡‡è´­ç§‘çº³å’–å•¡å’Œæ‰‹å·¥è‰ºå“ã€‚" }, en: { name: "Final Swim", time: "AM", desc: "Last swim at AnaehoÊ»omalu Bay. Visit farmers market for coffee and crafts." } },
                { id: 1, icon: "ğŸ›«", zh: { name: "å‰å¾€æœºåœº", time: "11:00 AM", desc: "å‰å¾€ KOA æœºåœºè¿˜è½¦ã€‚æ¬£èµæœ€åçš„æµ·æ™¯ï¼Œä¹˜å 1:58 PM èˆªç­å‘Šåˆ«å¤§å²›ã€‚" }, en: { name: "To Airport", time: "11:00 AM", desc: "Head to airport, return car. 1:58 PM flight departure." } }
            ]}
        };

        const translations = {
            zh: { 
                navTitle: "å¤å¨å¤·å¤§å²›å¤§å†’é™©", 
                navDesc: "ä»çœ‹ç«å±±å£å²©æµ†åˆ°ç»ç¾æ²™æ»© and æ·±é‚ƒæµ·åº•ï¼", 
                timelineTitle: "å†’é™©è·¯å¾„", 
                langToggle: "ä¸­ / EN", 
                coreQuest: "â­ æ ¸å¿ƒä»»åŠ¡", 
                expertInsight: "ğŸ’¡ ä¸“å®¶å»ºè®®", 
                comments: "ğŸ“ æˆ‘çš„å¤‡æ³¨", 
                resetView: "é‡ç½®è§†å›¾",
                hidePois: "éšè—æ™¯ç‚¹",
                showPois: "æ˜¾ç¤ºæ™¯ç‚¹"
            },
            en: { 
                navTitle: "HAWAII ADVENTURE", 
                navDesc: "From volcanic lava to stunning beaches and deep oceans!", 
                timelineTitle: "PATH", 
                langToggle: "EN / ä¸­", 
                coreQuest: "â­ CORE QUESTS", 
                expertInsight: "ğŸ’¡ EXPERT INSIGHTS", 
                comments: "ğŸ“ MY NOTES", 
                resetView: "Reset View",
                hidePois: "Hide POIs",
                showPois: "Show POIs"
            }
        };

        function initMap() {
            leafletMap = L.map('map', { zoomControl: false, minZoom: 7 }).setView(INITIAL_MAP_CENTER, INITIAL_MAP_ZOOM);
            L.control.zoom({ position: 'bottomright' }).addTo(leafletMap);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);

            const airportIcon = L.divIcon({ className: 'plane-marker', html: 'âœˆï¸', iconSize: [44, 44], iconAnchor: [22, 22] });
            const airportCoords = [19.738, -156.046];
            L.marker(airportCoords, { icon: airportIcon }).addTo(leafletMap).bindTooltip("Kona (KOA)");

            renderMapMarkers();
            
            const routePoints = [
                airportCoords, 
                itinerary[1].coords, 
                itinerary[2].coords, 
                itinerary[3].coords, 
                itinerary[4].coords, 
                itinerary[5].coords, 
                itinerary[6].coords, 
                airportCoords
            ];

            L.polyline(routePoints, { color: '#1cb0f6', weight: 8, opacity: 0.15 }).addTo(leafletMap);
            L.polyline(routePoints, { color: '#1cb0f6', weight: 4, opacity: 0.8, className: 'route-path-flow' }).addTo(leafletMap);

            for (let i = 0; i < routePoints.length - 1; i++) {
                const p1 = routePoints[i];
                const p2 = routePoints[i+1];
                const mid = [ (p1[0] + p2[0]) / 2, (p1[1] + p2[1]) / 2 ];
                const angle = Math.atan2(p2[1] - p1[1], p2[0] - p1[0]) * 180 / Math.PI;
                L.marker(mid, {
                    icon: L.divIcon({
                        className: 'arrow-icon',
                        html: `<div style="transform: rotate(${-angle}deg)">â¤</div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(leafletMap);
            }
        }

        function resetMapView() {
            if (leafletMap) {
                leafletMap.flyTo(INITIAL_MAP_CENTER, INITIAL_MAP_ZOOM, { duration: 1.5 });
            }
        }

        function togglePoiVisibility() {
            poisVisible = !poisVisible;
            renderMapMarkers();
            updatePoiButtonText();
        }

        function updatePoiButtonText() {
            const t = translations[currentLang];
            const btnText = document.getElementById('poi-toggle-text');
            if (btnText) btnText.innerText = poisVisible ? t.hidePois : t.showPois;
        }

        function renderTimeline() {
            const container = document.getElementById('path-grid');
            container.innerHTML = '';
            const displayOrder = [1, 2, 4, 3, 5, 6];
            displayOrder.forEach((dayNum) => {
                const d = itinerary[dayNum];
                const dayData = d[currentLang];
                const node = document.createElement('div');
                node.id = `node-${dayNum}`;
                node.className = 'text-center group cursor-pointer relative z-10 flex flex-col items-center';
                node.onclick = () => showDay(parseInt(dayNum));
                node.innerHTML = `
                    <div class="timeline-day-text" style="color: ${d.color};">${dayData.date}</div>
                    <div class="step-circle text-white text-2xl shadow-md" id="circle-${dayNum}" style="background-color: ${d.color}">
                        ${['ğŸŒ‹','ğŸ‘£','ğŸŒ¿','ğŸ','ğŸ‹','âœˆï¸'][dayNum-1]}
                    </div>
                    <div class="timeline-title-text text-gray-700 transition-opacity group-hover:opacity-70">${dayData.timeline}</div>
                `;
                container.appendChild(node);
            });

            const linesHtml = `
                <div class="snake-line line-h" style="left: 25%; top: 72px; width: 50%;"></div>
                <div class="snake-line line-v" style="right: 25%; top: 72px; height: 154px;"></div>
                <div class="snake-line line-h" style="left: 25%; top: 222px; width: 50%;"></div>
                <div class="snake-line line-v" style="left: 25%; top: 222px; height: 154px;"></div>
                <div class="snake-line line-h" style="left: 25%; top: 372px; width: 50%;"></div>
            `;
            container.insertAdjacentHTML('beforeend', linesHtml);
        }

        function getDisplayEvents(dayNum) {
            const baseEvents = itinerary[dayNum].events;
            const saved = userEdits[dayNum];
            if (saved && saved.eventOrder) {
                return saved.eventOrder.map(oi => {
                    const b = baseEvents.find(be => be.id === oi.id);
                    return { ...b, customDesc: oi.customDesc };
                });
            }
            return baseEvents;
        }

        function showDay(dayNum) {
            const data = itinerary[dayNum];
            const langData = data[currentLang];
            const modal = document.getElementById('dayModal');
            const contentArea = document.getElementById('modalContent');
            const t = translations[currentLang];

            document.querySelectorAll('.step-circle').forEach(c => c.classList.remove('active'));
            const circle = document.getElementById(`circle-${dayNum}`);
            if(circle) circle.classList.add('active');

            const savedDay = userEdits[dayNum] || {};
            const eventsToRender = getDisplayEvents(dayNum);

            let html = `<div class="section-title">${t.coreQuest}</div><div id="sortable-events" class="space-y-8">`;
            eventsToRender.forEach((e) => {
                const displayDesc = e.customDesc || e[currentLang].desc;
                html += `
                <div class="flex gap-6 items-start p-2 rounded-xl transition-colors ${editMode ? 'hover:bg-gray-100 cursor-move border-2 border-dashed border-gray-300' : ''}" data-id="${e.id}">
                    <div class="drag-handle self-center p-1 text-gray-400 font-bold text-2xl">â£¿</div>
                    <div class="w-16 h-16 bg-white duo-card rounded-2xl flex items-center justify-center shrink-0 text-4xl shadow-sm">${e.icon}</div>
                    <div class="pt-1 flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-gray-100 text-gray-500 font-black text-[11px] px-2 py-0.5 rounded-md uppercase tracking-wide">${e[currentLang].time || 'Mission'}</span>
                        </div>
                        <h4 class="font-black text-2xl text-gray-800 leading-tight mb-2">${e[currentLang].name}</h4>
                        <p class="editable-field text-gray-600 text-sm md:text-lg leading-relaxed mt-1 font-bold" contenteditable="${editMode}" onblur="saveEventData(${dayNum})">${displayDesc}</p>
                    </div>
                </div>`;
            });
            html += `</div>`;
            
            html += `<div class="section-title mt-10">${t.expertInsight}</div><div class="bg-orange-50 p-6 rounded-3xl border-2 border-orange-100 font-bold text-orange-800 text-lg italic">${langData.expert}</div>`;
            html += `<div class="comment-box">
                <h5 class="font-black text-[11px] text-gray-400 uppercase tracking-widest mb-2">${t.comments}</h5>
                <textarea class="w-full bg-transparent border-none focus:ring-0 text-gray-700 font-black italic text-lg" onblur="saveComment(${dayNum}, this.value)">${savedDay.comments || ""}</textarea>
            </div>`;

            // Prepare the view updates
            document.getElementById('modalHeader').style.backgroundColor = data.color;
            document.getElementById('modalTitle').innerText = langData.title;
            document.getElementById('modalDate').innerText = langData.date;
            
            // Set content and explicitly scroll to top
            contentArea.innerHTML = html;
            
            // Show modal first
            modal.style.display = 'flex';
            
            // Critical fix: Ensure scroll reset happens after the display is set and layout is processed
            contentArea.scrollTop = 0;
            requestAnimationFrame(() => {
                contentArea.scrollTop = 0;
            });

            if(leafletMap) leafletMap.flyTo(data.coords, 14, { duration: 1.5 });
            
            if (editMode) {
                Sortable.create(document.getElementById('sortable-events'), { 
                    handle: '.drag-handle', 
                    animation: 150, 
                    ghostClass: 'sortable-ghost', 
                    onEnd: () => saveEventData(dayNum) 
                });
            }
        }

        function saveEventData(dayNum) {
            const eventElems = document.querySelectorAll('#sortable-events > div');
            const newOrder = [];
            eventElems.forEach(el => {
                const id = parseInt(el.getAttribute('data-id'));
                const desc = el.querySelector('.editable-field').innerText;
                newOrder.push({ id, customDesc: desc });
            });
            if (!userEdits[dayNum]) userEdits[dayNum] = {};
            userEdits[dayNum].eventOrder = newOrder;
            persist();
        }

        function saveComment(dayNum, text) {
            if (!userEdits[dayNum]) userEdits[dayNum] = {};
            userEdits[dayNum].comments = text;
            persist();
        }

        function persist() {
            localStorage.setItem('hawaii_adventure_v1', JSON.stringify(userEdits));
            const indicator = document.getElementById('save-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 1500);
        }

        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('edit-toggle').classList.toggle('active');
            const modal = document.getElementById('dayModal');
            if (modal.style.display === 'flex') {
                const active = document.querySelector('.step-circle.active');
                if (active) showDay(parseInt(active.id.split('-')[1]));
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            renderTimeline();
            const t = translations[currentLang];
            document.getElementById('nav-title').innerText = t.navTitle;
            document.getElementById('nav-desc').innerText = t.navDesc;
            document.getElementById('timeline-title').innerText = t.timelineTitle;
            const editBtn = document.getElementById('edit-toggle');
            if (editBtn) editBtn.querySelector('span').innerText = (currentLang === 'zh' ? 'ç¼–è¾‘' : 'EDIT');
            const resetBtn = document.getElementById('reset-view-text');
            if (resetBtn) resetBtn.innerText = t.resetView;
            updatePoiButtonText();
            renderMapMarkers();
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('dayModal')) {
                document.getElementById('dayModal').style.display = 'none';
            }
        }

        function renderMapMarkers() {
            if(!leafletMap) return;
            activeMarkers.forEach(m => leafletMap.removeLayer(m));
            activeLabels.forEach(l => leafletMap.removeLayer(l));
            activePois.forEach(p => leafletMap.removeLayer(p));
            activeMarkers = []; 
            activeLabels = [];
            activePois = [];

            Object.keys(itinerary).forEach(dayNum => {
                const d = itinerary[dayNum];
                
                const marker = L.circleMarker(d.coords, { color: d.color, fillColor: d.color, fillOpacity: 1, weight: 6, radius: 16 }).addTo(leafletMap).on('click', () => showDay(dayNum));
                const label = L.marker(d.coords, { 
                    icon: L.divIcon({ 
                        className: 'custom-div-icon', 
                        html: `<div class="day-label" style="color:${d.color}">${currentLang === 'zh' ? 'ç¬¬' : 'Day'} ${dayNum} ${currentLang === 'zh' ? 'å¤©' : ''}</div>`,
                        iconAnchor: d.labelOffset || [45, 25] 
                    })
                }).addTo(leafletMap).on('click', () => showDay(dayNum));
                activeMarkers.push(marker); activeLabels.push(label);

                if (poisVisible && d.pois) {
                    d.pois.forEach(poi => {
                        const poiMarker = L.marker(poi.coords, {
                            icon: L.divIcon({
                                className: 'poi-marker',
                                html: `<span>${poi.icon}</span>`,
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            })
                        }).addTo(leafletMap).bindTooltip(currentLang === 'zh' ? poi.zh : poi.en);
                        activePois.push(poiMarker);
                    });
                }
            });
        }

        window.onload = () => { 
            initMap(); 
            renderTimeline(); 
        }
    </script>
</body>
</html>
